{% extends 'base.html' %}
{% load static %}
{% block title %}Shop{% endblock %}

{% block content %}
        <div class="hero-title">
            <h1>商品一覧</h1>
        </div>
        <div class="shop-layout">
            <form style="display: none;">{% csrf_token %}</form>
            <!-- サイドメニュー（一応） -->
            <div class="cyber-sidebar">
                <form id="search-form" method="get" action="{% url 'shop' %}">
                    <input type="text" name="q" placeholder="Search skin..." value="{{ query }}">

                    <select name="category">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if cat.id|stringformat:"s" == category_id %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                    </select>

                    <div class="price-range">
                        <input type="number" name="min_price" placeholder="Min ¥" value="{{ request.GET.min_price }}">
                        <input type="number" name="max_price" placeholder="Max ¥" value="{{ request.GET.max_price }}">
                    </div>

                    <select name="sort">
                    <option value="">Default Sort</option>
                    <option value="price_asc" {% if sort == "price_asc" %}selected{% endif %}>Price: Low to High</option>
                    <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>Price: High to Low</option>
                </select>

                    <button type="submit">SEARCH</button>
                </form>

            </div>
            <div class="product_list">
            <!-- ページネーション -->
                <div id="products-container" class="products-grid">
                    {% include 'shop/products_list.html' %}
                </div>

                <div id="pagination-container" class="cyber-pagination">
                    {% include 'shop/pagination.html' %}
                </div>
            </div>
        </div>

        <div id="champ-drawer-trigger" class="champ-sticky-btn">
            <i class="fas fa-users"></i>
            <span>CHAMPIONS</span>
        </div>

        <div id="champ-drawer" class="cyber-drawer">
            <div class="drawer-header">
                <h3>CHAMPIONS</h3>
                <button type="button" id="close-drawer">&times;</button>
            </div>
            
            <div class="drawer-search">
                <input type="text" id="inner-search" placeholder="Quick find...">
            </div>

            <div class="champion-list-drawer">
                <ul id="drawer-ul">
                    <li><a href="#" class="champion-link active" data-champion="">All Champions</a></li>
                    {% for champ in champions %}
                    <li><a href="#" class="champion-link" data-champion="{{ champ }}">{{ champ }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div id="drawer-overlay" class="drawer-overlay"></div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>   
    <script>
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        }

        function showToast(msg) {
             const toast = $("<div class='toast-global'>" + msg + "</div>");
              $("body").append(toast); setTimeout(() => toast.addClass("show"), 100);
               setTimeout(() => toast.remove(), 3200);
             }

        $(document).ready(function () {

            // Drawer Logic Functions
            // 1. Buka Drawer
            $('#champ-drawer-trigger').on('click', function() {
                $('#champ-drawer').addClass('active');
                $('#drawer-overlay').fadeIn();
            });

            // 2. Tutup Drawer
            function closeDrawer() {
                $('#champ-drawer').removeClass('active');
                $('#drawer-overlay').fadeOut();
            }
            $('#close-drawer, #drawer-overlay').on('click', closeDrawer);

            // 3. Mini Search Filter (Sangat membantu buat 170 items)
            $('#inner-search').on('keyup', function() {
                let val = $(this).val().toLowerCase();
                $('#drawer-ul li').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(val) > -1)
                });
            });

            // 4. Otomatis tutup drawer setelah pilih champion (Optional)
            $(document).on('click', '.champion-link', function() {
                if ($(window).width() < 768) { // Cuma auto-close di mobile biar gak ribet
                    closeDrawer();
                }
            });
            // End

            function loadProducts(params) {
                $.ajax({
                    url: "{% url 'shop' %}",
                    data: params,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function (response) {
                        $('#products-container').html(response.html);
                        $('#pagination-container').html(response.pagination);
                    }
                });
            }

            function getFilters() {
                return {
                    q: $('input[name="q"]').val(),
                    category: $('select[name="category"]').val(),
                    champion: $('.champion-link.active').data('champion'),
                    min_price: $('input[name="min_price"]').val(),
                    max_price: $('input[name="max_price"]').val(),
                    sort: $('select[name="sort"]').val()
                };
            }

            $('#search-form').on('submit', function (e) {
                e.preventDefault();
                loadProducts(getFilters());
            });

            $(document).on('click', '.category-link', function (e) {
                e.preventDefault();
                $('.category-link').removeClass('active');
                $(this).addClass('active');
                loadProducts(getFilters());
            });

            $(document).on('click', '.champion-link', function (e) {
                e.preventDefault();
                $('.champion-link').removeClass('active');
                $(this).addClass('active');
                loadProducts(getFilters());
            });

            $('select[name="sort"]').on('change', function () {
                loadProducts(getFilters());
            });

            $(document).on('click', '.page-link', function (e) {
                e.preventDefault();
                const params = getFilters();
                params.page = $(this).data('page'); 
                loadProducts(params);
            });

            $(document).on('click', '.add-to-cart-btn', function () {
                const productId = $(this).data('id');
                fetch(`/add-to-cart-ajax/${productId}/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCSRFToken()}
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') showToast(data.message);
                });
            });

        });
    </script>
{% endblock %}

</html>